set -e

echo "Building target lua-openssl"

SRC_DIR=$(pwd)/deps/zhaog/lua-openssl
BUILD_DIR=$SRC_DIR/cmakebuild-unix
OUT_DIR=$(pwd)/ninjabuild-unix

LUAJIT_SRC_DIR=$(pwd)/deps/LuaJIT/LuaJIT/src
LUAJIT_LIBRARY_PATH=$OUT_DIR/libluajit.a
STATIC_LUAJIT_FLAGS="-DLUAJIT_INCLUDE_DIRS=$LUAJIT_SRC_DIR -DLUA_INCLUDE_DIR=$LUAJIT_SRC_DIR -DLUAJIT_LIBRARY=$LUAJIT_LIBRARY_PATH "

OPENSSL_DIR=$OUT_DIR
OPENSSL_INCLUDE_DIR=$(pwd)/deps/openssl/openssl/include
STATIC_OPENSSL_FLAGS="-DOPENSSL_INCLUDE_DIR=$OPENSSL_INCLUDE_DIR -DOPENSSL_USE_STATIC_LIBS=ON -DOPENSSL_ROOT_DIR=$OPENSSL_DIR"

cmake -S $SRC_DIR -B $BUILD_DIR -G Ninja -DBUILD_SHARED_LUA_OPENSSL=OFF -DCMAKE_C_COMPILER=gcc -DLUA_OPENSSL_LIBTYPE=STATIC $STATIC_OPENSSL_FLAGS $STATIC_LUAJIT_FLAGS
cmake --build $BUILD_DIR --clean-first

cp $BUILD_DIR/openssl.a $OUT_DIR
